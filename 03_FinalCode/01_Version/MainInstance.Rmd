---
title: "Stocks competition"
author: "Max Franke & Damian Etchevest"
output: html_notebook
---
Class: CIS-544 DATA MINING & MACHINE LRNG
Term: SPRING/T1

Last modified date: 02/23/2020

# Stocks Iterations  {.tabset .tabset-fade .tabset-pills}
## Workspace preparation
### Approach
***
In this section the workspace will be prepared. This means that first the global environment will be cleaned, and all required packages will be loaded. The data is hosted in a database in the aws Cloud and is loaded into R via a SQL connection. The data is transformed into R accordingly (ELT).

***
### Clean Workspace
```{r}
rm(list = ls())
```

### Install libraries
```{r}
#install.packages("alphavantager")
#install.packages("jsonlite")
#install.packages("TTR")
#install.packages("ncar")
#install.packages("xts")
#install.packages("dplyr")
#install.packages("quantmod")
#install.packages("tidyverse")
#install.packages("quantmod)
#install.packages("magrittr)
```

### Load Packages
```{r}
# Load packages
#library(alphavantager)
library(jsonlite)
library(forecast)
#library(TTR)
#library(ncar)
#library(dplyr)
#library(xts)
#library(quantmod)
#library(tidyverse)
library(RMySQL)
library(quantmod)
library(magrittr)
```
### CONSTANT VARIABLES
```{r}
TRANSACTION <- 250
TOTAL_PROFILE <- fromJSON("https://www.projectrex.net/stocks/?key=2b726457&av_key=OBEKR8AXV71DDV2I&request=profile")

PROFILE <- data.frame(matrix(nrow = 0, ncol = 4))
colnames(PROFILE) <- c("shares.symbol", "shares.price", "shares.quantity", "shares.total", "Strategy")
PROFILE <- rbind(PROFILE, data.frame(shares.symbol = TOTAL_PROFILE$shares.symbol,
                                     shares.price = TOTAL_PROFILE$shares.price,
                                     shares.quantity = TOTAL_PROFILE$shares.quantity,
                                     shares.total = TOTAL_PROFILE$shares.total))

ALL_SYMBOLS <- c("AEY", "NIO", "ZNGA", "BBD", "ITUB", "SBI", "TCS", "VEDL", "TCS", "CSCO", "YESBANK.NS", "ZEEL.NS", "TSLA", "INO", "GGB")
```
### Database
```{r}
# Connect to database
mydb <- dbConnect(MySQL(),
                  username = 'exolar',
                  password = '4157922486',
                  dbname = "Stock_Market",
                  host = "stockproject.cyakxe88a8zf.us-east-1.rds.amazonaws.com"
)
```
### Preperation
```{r}
# Inconstant variables
transaction <- 0

# Define colnames for Buy
colnames <- c("Position_ID", "Symbol", "Price", "Quantity", "Datetime","Strategy","EMA150","EMA100","EMA50",
              "Slope150","Slope100","Slope50","RSI","bb_dn","bb_mavg","bb_up","bb_pctB","macd","Transaction", "image")

# Keys and Symbols
#---------------------------------------------------------------------------------------------------------------------------------------

Symbols_and_Keys <- data.frame(Symbols = c("AEY", "NIO", "ZNGA", "BBD", "ITUB"),
                               Keys = c("4VVBL1TC49P4UGCF", "GMKV8VI4C916MXJF", "H6WI8CS26BKYMAQA", "UIDZK6YQ4N2821T4", "NI7UAFT2US5VZDM2"))

# Save the translation vector from m to degree
#---------------------------------------------------------------------------------------------------------------------------------------
degree <- data.frame(degree = c(0.1, 0.2, 0.3, 0.4, 0.5, 0.57, 0.6, 0.7, 0.8, 0.9, 1, 2, 3, 4, 5, 5.74, 6:90))
m <- data.frame(m = c(573.0,286.5,191.0,143.2,114.6,100,95.49,81.85,71.62,63.66,57.29,28.64,19.08,14.30,11.43,10,9.514,8.144,7.115,6.314,5.671,5.145,4.705,4.331,4.011,3.732,3.487,3.271,3.078,2.904,2.747,2.605,2.475,2.356,2.246,2.145,2.050,1.963,1.881,1.804,1.732,1.664,1.600,1.540,1.483,1.428,1.376,1.327,1.280,1.235,1.192,1.150,1.111,1.072,1.036,1.000,0.9657,0.9325,0.9004,0.8693,0.8391,0.8098,0.7813,0.7536,0.7265,0.7002,0.6745,0.6494,0.6249,0.6009,0.5774,0.5543,0.5317,0.5095,0.4877,0.4663,0.4452,0.4245,0.4040,0.3839,0.3640,0.3443,0.3249,0.3057,0.2867,0.2679,0.2493,0.2309,0.2126,0.1944,0.1763,0.1584,0.1405,0.1228,0.1051,0.08749,0.06993,0.05241,0.03492,0.01746,0.00000))
degree_m <- cbind(degree, m)
degree_m <- rbind(degree_m, data.frame(degree = degree * -1, m = m*-1))
```

## Global Functions
### Approach
***
In this section we are creating global functions:
Get the Price
Calculate the degree of a slope
Buy / Sell call (quantity to buy and symbol to buy as variables)
Indicators (slope for EMA’s, EMA’s, RSI, bb, stochastic, macd etc.)
Time Series

***
### Get the price
```{r}
Price <- function(symbol,key){
  df_price <- read.csv.zoo(paste("https://www.alphavantage.co/query?function=TIME_SERIES_INTRADAY&symbol=",
                                 symbol,
                                 "&interval=1min&outputsize=full&apikey=",
                                 key,"&datatype=csv", sep = ""))
  return(df_price)
}
```

### Slope Function, calculate the degree of slope [FOR THE FIRST COLUMN OF THE INPUT DATAFRAME]
```{r}

slope <- function(x){
  # Load data
  x <- as.data.frame(x)
  # Colname
  colnames(x) <- "Price"
  # Count every Minute
  x$Min <- c(1:nrow(x))
  # Normalize the distance in order to calculate the slope
  x$Min_nom <- (x$Min - min(x$Min)) / (max(x$Min) - min(x$Min))
  # slope from last point to the first point
  slope <- (tail(x[,1], 1) - head(x[which(!is.na(x$Price)),1], 1))/(tail(x$Min_nom, 1) - head(x$Min_nom, 1))
  # Position in translation dataframe
  position <- which.min(abs(degree_m$m - slope))
  # Degree
  slope_to_degree <- degree_m[position, 1] 
  # Return degree
  return(slope_to_degree)
}
```

### Buy call
```{r}
buy <- function(symbol_to_buy, quantity_to_buy) {
  url <- paste("https://projectrex.net/stocks/?key=2b726457&av_key=OBEKR8AXV71DDV2I&request=buy&quantity=", quantity_to_buy, "&symbol=", symbol_to_buy, sep = "")
  return(url)
}
```

### Sell call
```{r}
sell <- function(symbol_to_sell, quantity_to_sell){
  url <- paste("https://projectrex.net/stocks/?key=2b726457&av_key=OBEKR8AXV71DDV2I&request=sell&quantity=", quantity_to_sell, "&symbol=", symbol_to_sell, sep = "")
  return(url)
}
```

### Indicators
```{r}
indicators <- function(df_price){
  
  # Slope for EMA
  slope_EMA_150 <- slope(as.data.frame(tail(EMA(Cl(df_price),150),150)))
  slope_EMA_100 <- slope(as.data.frame(tail(EMA(Cl(df_price),100),100)))
  slope_EMA_50 <- slope(as.data.frame(tail(EMA(Cl(df_price),50),50)))
  # EMA
  EMA_150 <- tail(EMA(Cl(df_price),150),1)[[1]] 
  EMA_100 <-tail(EMA(Cl(df_price),100),1)[[1]] 
  EMA_50 <- tail(EMA(Cl(df_price),50),1)[[1]] 
  # BB & RSI
  bb <- BBands(Cl(df_price),s.d=2) %>% tail(n=1)
  rsi <- RSI(Cl(df_price),n=8) %>% tail(n=1)
  # MACD
  macd <- MACD(Cl(df_price), nFast=12, nSlow=26,
               nSig=9, maType=SMA) %>% tail(n=1)
  # Stochastic
  stochastic <- mean(tail(stoch(df_price[,c("high","low","close")]),1)[,2:3]) * 100
  # Save to an Object
  Objects <- list("slope_150" = slope_EMA_150,
                  "slope_100" = slope_EMA_100,
                  "slope_50" = slope_EMA_50,
                  "EMA_150" = EMA_150, 
                  "EMA_100" = EMA_100,
                  "EMA_50" = EMA_50, 
                  "bb" = bb,
                  "rsi" = rsi, 
                  "macd" = macd,
                  "stochastic" = stochastic)
  # Save to the global environment
  assign("Indicators",as.data.frame(Objects),envir = .GlobalEnv)
  return(Objects)
}

```



















































